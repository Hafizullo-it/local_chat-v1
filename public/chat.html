<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chat-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω */
            background-size: cover;
            background-position: center;
        }

        .right-panel.active {
            display: flex;
        }

        .message-info .fa-check {
            color: #ccc;
        }
        .message-info .fa-check-double {
            color: #3b82f6;
        }

        .user-item button {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .user-item:hover button {
            opacity: 1;
        }
        #emoji-picker.hidden {
            display: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes dot-pulse {
            0%, 100% { transform: translateY(0); opacity: 0.8; }
            50% { transform: translateY(-3px); opacity: 1; }
        }
        .dot-pulse {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .dot-pulse::before, .dot-pulse::after, .dot-pulse div {
            content: '';
            width: 6px;
            height: 6px;
            background-color: #9ca3af; /* gray-400 */
            border-radius: 50%;
            animation: dot-pulse 1s infinite ease-in-out;
        }
        .dot-pulse::before { animation-delay: 0s; }
        .dot-pulse div { animation-delay: 0.2s; }
        .dot-pulse::after { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-gray-900 text-gray-100 h-screen flex overflow-hidden">

<div class="w-80 bg-gray-800 bg-opacity-80 backdrop-filter backdrop-blur-lg border-r border-gray-700 flex flex-col">
    <div class="p-4 flex items-center justify-between border-b border-gray-700">
        <div class="flex items-center gap-3">
            <img id="my-ava" class="w-12 h-12 rounded-full object-cover border-2 border-blue-500">
            <b id="my-name" class="text-lg font-semibold text-white"></b>
        </div>
        <div class="flex gap-1">
            <button id="admin-panel-btn" class="text-gray-400 hover:text-blue-400 transition-colors duration-200 p-2 rounded-full hover:bg-gray-700 hidden" onclick="(() => { const u = JSON.parse(localStorage.getItem('user')); if(u && (u.role === 'admin' || u.username === 'admin')){window.location.href='/admin-access?userId='+u.id}else{alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏')} })()" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
                <i class="fas fa-shield-alt text-xl"></i>
            </button>
            <button class="text-gray-400 hover:text-blue-400 transition-colors duration-200 p-2 rounded-full hover:bg-gray-700" onclick="logout()" title="–í—ã–π—Ç–∏">
                <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
        </div>
    </div>
    <div class="p-2 overflow-y-auto flex-grow">
        <div class="p-3 cursor-pointer flex items-center gap-3 rounded-lg mx-2 my-1 relative transition-colors duration-200 hover:bg-gray-700" id="btn-global" onclick="openGlobal()">
            <span class="text-2xl">üåç</span>
            <div class="flex-grow">
                <b class="font-semibold text-white">–û–±—â–∏–π —á–∞—Ç</b>
            </div>
        </div>
        <div id="user-list"></div>
    </div>
    <div class="p-4 border-t border-gray-700">
        <a href="#" class="text-blue-400 hover:underline flex items-center gap-2" onclick="openProfileSettings()">
            <i class="fas fa-cog text-lg"></i>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</span>
        </a>
    </div>
</div>

<div class="flex-grow flex flex-col bg-gray-900 relative chat-main">
    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg">
        <div class="flex items-center gap-3">
            <img id="chat-avatar" class="w-10 h-10 rounded-full object-cover hidden">
            <b id="chat-with" class="text-lg font-semibold text-white">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</b>
        </div>
        <button class="text-gray-400 hover:text-blue-400 transition-colors duration-200 p-2 rounded-full hover:bg-gray-700" onclick="toggleRightPanel()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ">
            <i class="fas fa-info-circle text-xl"></i>
        </button>
    </div>

    <!-- Pinned Message -->
    <div id="pinned-message" class="bg-blue-800 bg-opacity-30 p-3 text-sm text-blue-100 flex items-start gap-3 hidden border-b border-blue-700">
        <i class="fas fa-thumbtack text-blue-300 mt-0.5"></i>
        <span class="flex-grow">üìú –ü–†–ê–í–ò–õ–ê –°–û–û–ë–©–ï–°–¢–í–ê: Spam/Flood ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞. Profanity & Insults ‚Äî –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã –≤ –ª—é–±–æ–π —Ñ–æ—Ä–º–µ. Fake Identities ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á—É–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –°–æ–±–ª—é–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∏–∫–µ—Ç. –ù–∞—Ä—É—à–µ–Ω–∏–µ ‚Äî –±–∞–Ω –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.</span>
    </div>

    <div id="messages" class="flex-grow overflow-y-auto p-4 flex flex-col gap-3 overscroll-contain"></div>

    <div id="typing-indicator" class="text-sm text-gray-400 px-4 py-2 italic transition-opacity duration-300 flex items-center gap-2 hidden">
        <div class="dot-pulse">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <span>–ü–µ—á–∞—Ç–∞–µ—Ç...</span>
    </div>

    <div id="mention-autocomplete" class="absolute bottom-20 left-4 bg-gray-800 border border-gray-700 rounded-lg p-2 z-50 shadow-2xl hidden"></div>

    <div id="reply-preview" class="bg-gray-700 bg-opacity-70 border-l-4 border-blue-400 p-2 rounded-lg text-xs mb-1 flex items-center justify-between hidden">
        <div class="flex-grow">
            <div id="reply-original-sender" class="font-bold text-blue-300"></div>
            <div id="reply-original-content" class="text-gray-200 truncate"></div>
        </div>
        <button class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gray-600 transition-colors duration-200" onclick="cancelReply()" title="–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç">
            <i class="fas fa-times text-lg"></i>
        </button>
    </div>

    <div id="emoji-picker" class="absolute bottom-20 left-4 bg-gray-800 border border-gray-700 rounded-lg p-2 z-50 shadow-2xl grid grid-cols-6 gap-1"></div>

    <div class="p-4 bg-gray-800 bg-opacity-70 backdrop-filter backdrop-blur-lg border-t border-gray-700 flex gap-3 items-center">
        <input type="file" id="fileInput" class="hidden" onchange="uploadFile(this)">
        <button class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200 text-lg" onclick="document.getElementById('fileInput').click()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
            <i class="fas fa-paperclip"></i>
        </button>
        <button class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200 text-lg" onclick="toggleEmoji(event)" title="–≠–º–æ–¥–∑–∏">
            <i class="fas fa-smile"></i>
        </button>
        <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-full p-3 text-white placeholder-gray-400 flex-grow focus:outline-none focus:border-blue-500 transition-colors duration-200">
        <button class="p-2 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-colors duration-200 text-lg" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<div id="right-panel" class="w-72 bg-gray-800 bg-opacity-80 backdrop-filter backdrop-blur-lg border-l border-gray-700 flex-col p-4 transition-all duration-300 ease-in-out hidden lg:flex">
    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
        <h5 class="text-xl font-semibold text-white">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</h5>
        <button class="text-gray-400 hover:text-blue-400 p-1 rounded-full hover:bg-gray-700 lg:hidden" onclick="toggleRightPanel()" title="–ó–∞–∫—Ä—ã—Ç—å">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>
    <div class="mb-6">
        <h6 class="text-gray-300 font-semibold mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω (<span id="members-count" class="text-blue-400">0</span>)</h6>
        <div id="members-list" class="overflow-y-auto max-h-48 custom-scrollbar pr-2"></div>
    </div>
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ –∑–¥–µ—Å—å -->
    <div class="mt-auto pt-4 border-t border-gray-700 text-sm text-gray-400">
        <p>–í–µ—Ä—Å–∏—è —á–∞—Ç–∞: 3.2</p>
        <p>&copy; by No Name</p>
    </div>
</div>

<!-- Profile Settings Modal -->
<div id="profile-settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
        <h3 class="text-2xl font-bold mb-5 text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <div class="mb-4">
            <label for="profile-username" class="block text-gray-300 text-sm font-semibold mb-2">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input type="text" id="profile-username" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>
        <div class="mb-4">
            <label for="profile-old-password" class="block text-gray-300 text-sm font-semibold mb-2">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="profile-old-password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        <div class="mb-4">
            <label for="profile-new-password" class="block text-gray-300 text-sm font-semibold mb-2">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="profile-new-password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        <div class="mb-6">
            <label for="profile-avatar" class="block text-gray-300 text-sm font-semibold mb-2">–ê–≤–∞—Ç–∞—Ä:</label>
            <input type="file" id="profile-avatar" class="w-full text-white bg-gray-700 bg-opacity-50 rounded-lg p-2 border border-gray-600 cursor-pointer">
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" onclick="closeProfileSettings()">–û—Ç–º–µ–Ω–∞</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="saveProfileSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="context-menu" class="fixed hidden bg-gray-800 p-2 rounded-lg shadow-xl z-50 flex flex-col">
    <button class="flex items-center gap-2 p-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md cursor-pointer" onclick="handleReply()">
        <i class="fas fa-reply text-blue-400"></i>
        <span>–û—Ç–≤–µ—Ç–∏—Ç—å</span>
    </button>
    <button class="flex items-center gap-2 p-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md cursor-pointer" onclick="handleEdit()">
        <i class="fas fa-edit text-yellow-400"></i>
        <span>–ò–∑–º–µ–Ω–∏—Ç—å</span>
    </button>
    <button class="flex items-center gap-2 p-2 text-sm text-red-400 hover:bg-gray-700 rounded-md cursor-pointer" onclick="handleDelete()">
        <i class="fas fa-trash text-red-500"></i>
        <span>–£–¥–∞–ª–∏—Ç—å</span>
    </button>
    <!-- –ö–Ω–æ–ø–∫–∞ –±–∞–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>

<!-- Edit Message Modal -->
<div id="edit-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
        <h3 class="text-2xl font-bold mb-5 text-white">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
        <div class="mb-6">
            <label for="edit-msg-input" class="block text-gray-300 text-sm font-semibold mb-2">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
            <textarea id="edit-msg-input" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" onclick="closeEditMessageModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="saveEditedMessage()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script src="script.js"></script>
    <!-- Context Menu for Users -->
    <div id="user-context-menu" class="fixed hidden bg-gray-800 p-2 rounded-lg shadow-xl z-50 flex flex-col">
        <button class="flex items-center gap-2 p-2 text-sm text-red-400 hover:bg-gray-700 rounded-md cursor-pointer" onclick="handleBanFromUserMenu()">
            <i class="fas fa-user-slash text-red-500"></i>
            <span>–ó–∞–±–∞–Ω–∏—Ç—å</span>
        </button>
        <button class="flex items-center gap-2 p-2 text-sm text-yellow-400 hover:bg-gray-700 rounded-md cursor-pointer" onclick="handleEditUser()">
            <i class="fas fa-user-edit text-yellow-500"></i>
            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
        </button>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold mb-5 text-white">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <div class="mb-4">
                <label for="edit-user-username" class="block text-gray-300 text-sm font-semibold mb-2">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="edit-user-username" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="mb-4">
                <label for="edit-user-avatar" class="block text-gray-300 text-sm font-semibold mb-2">–ê–≤–∞—Ç–∞—Ä:</label>
                <input type="file" id="edit-user-avatar" class="w-full text-white bg-gray-700 bg-opacity-50 rounded-lg p-2 border border-gray-600 cursor-pointer">
            </div>
            <div class="mb-4">
                <label for="edit-user-role" class="block text-gray-300 text-sm font-semibold mb-2">–†–æ–ª—å:</label>
                <select id="edit-user-role" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:outline-none focus:border-blue-500">
                    <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                    <option value="admin">–ê–¥–º–∏–Ω</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" onclick="closeEditUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="saveEditedUser()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

</body>
</html>